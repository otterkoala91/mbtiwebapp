import os
import streamlit as st
import google.generativeai as genai
import random

# -----------------------------------------------------------------
# 1. API í‚¤ ì„¤ì • (Streamlitì˜ 'ë¹„ë°€ ì„œë'ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
# -----------------------------------------------------------------
try:
    # Streamlit ë°°í¬ í™˜ê²½ (Secrets)
    api_key = os.environ.get('GEMINI_API_KEY')
    if not api_key:
        # ë¡œì»¬ .env íŒŒì¼ (ì„ íƒ ì‚¬í•­)
        from dotenv import load_dotenv
        load_dotenv()
        api_key = os.environ.get('GEMINI_API_KEY')

    if api_key:
        genai.configure(api_key=api_key)
    else:
        st.error("ì•—! ì œë¯¸ë‚˜ì´ API í‚¤ê°€ 'ë¹„ë°€ ì„œë(Secrets)'ì— ì„¤ì •ë˜ì§€ ì•Šì•˜ì–´ìš”. ğŸ˜¥")
        st.stop() # í‚¤ê°€ ì—†ìœ¼ë©´ ì•± ì¤‘ì§€

except ImportError:
    st.error("`dotenv` ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œì»¬ ì‹¤í–‰ ì‹œ `pip install python-dotenv`ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
    st.stop()
except Exception as e:
    st.error(f"API í‚¤ ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    st.stop()


# -----------------------------------------------------------------
# 2. í€´ì¦ˆ ë°ì´í„° (ì„ ìƒë‹˜ì˜ HTML ì½”ë“œì—ì„œ ê°€ì ¸ì˜´)
# -----------------------------------------------------------------

# 16ê°€ì§€ ìœ í˜•ë³„ ë³„ëª… ë° ì„¤ëª…
descriptions = {
    'ISTJ': { 'nickname': 'ì„±ì‹¤í•œ ëª¨ë²”ìƒ ğŸ§‘â€ğŸ«', 'desc': 'ì±…ì„ê°ì´ ê°•í•˜ê³  ë§¡ì€ ì¼ì„ ê¾¸ì¤€íˆ í•´ë‚´ëŠ” ì„±ì‹¤í•œ ì¹œêµ¬ì˜ˆìš”! ê·œì¹™ì„ ì˜ ì§€í‚¤ëŠ” ê²ƒì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•´ìš”.' },
    'ISFJ': { 'nickname': 'ë‹¤ì •í•œ ë•ê¸° ìš”ì • ğŸ§š', 'desc': 'ì¡°ìš©í•˜ê³  ì°¨ë¶„í•˜ì§€ë§Œ, ì¹œêµ¬ë“¤ì„ ë•ëŠ” ì¼ì— ê°€ì¥ ë¨¼ì € ë‚˜ì„œëŠ” ë”°ëœ»í•œ ë§ˆìŒì„ ê°€ì¡Œì–´ìš”.' },
    'INFJ': { 'nickname': 'ë”°ëœ»í•œ ì˜ˆì–¸ê°€ ğŸ”®', 'desc': 'ë‹¤ë¥¸ ì‚¬ëŒì˜ ë§ˆìŒì„ ì˜ ì´í•´í•˜ê³ , ë” ì¢‹ì€ ì„¸ìƒì„ ë§Œë“¤ê¸° ìœ„í•´ ê¹Šì´ ìƒê°í•˜ëŠ” ì¹œêµ¬ì˜ˆìš”.' },
    'INTJ': { 'nickname': 'ë˜‘ë˜‘í•œ ì „ëµê°€ ğŸ§ ', 'desc': 'í˜¸ê¸°ì‹¬ì´ ë§ê³  ë˜‘ë˜‘í•´ìš”! ë³µì¡í•œ ë¬¸ì œë„ ë…¼ë¦¬ì ìœ¼ë¡œ ì°©ì°© í•´ê²°í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•´ìš”.' },
    'ISTP': { 'nickname': 'ë§ŒëŠ¥ ì¬ì£¼ê¾¼ ğŸ› ï¸', 'desc': 'ì†ì¬ì£¼ê°€ ì¢‹ê³  ë„êµ¬ë¥¼ ì˜ ë‹¤ë¤„ìš”. ì§ì ‘ ë¬´ì–¸ê°€ë¥¼ ë§Œë“¤ê³  íƒí—˜í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•´ìš”.' },
    'ISFP': { 'nickname': 'ë§ˆìŒ ë”°ëœ»í•œ ì˜ˆìˆ ê°€ ğŸ¨', 'desc': 'ê²¸ì†í•˜ê³  ë§ˆìŒì´ ë”°ëœ»í•´ìš”. ì•„ë¦„ë‹¤ìš´ ê²ƒì„ ì¢‹ì•„í•˜ê³ , ì˜ˆìˆ ì ì¸ ê°ê°ì´ ë›°ì–´ë‚˜ìš”.' },
    'INFP': { 'nickname': 'ê¿ˆê¾¸ëŠ” ì´ìƒê°€ ëª½ìƒê°€ ğŸŒˆ', 'desc': 'ìƒìƒë ¥ì´ í’ë¶€í•˜ê³  ì°©í•´ìš”. ìì‹ ë§Œì˜ ê¿ˆê³¼ ê°€ì¹˜ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ì¹œêµ¬ì˜ˆìš”.' },
    'INTP': { 'nickname': 'ì•„ì´ë””ì–´ ë±…í¬ ğŸ’¡', 'desc': 'ì¡°ìš©í•˜ì§€ë§Œ ë¨¸ë¦¿ì†ì€ ì•„ì´ë””ì–´ë¡œ ê°€ë“ ì°¨ ìˆì–´ìš”! ë…¼ë¦¬ì ìœ¼ë¡œ ìƒê°í•˜ê³  ë¶„ì„í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•´ìš”.' },
    'ESTP': { 'nickname': 'í™œë°œí•œ íƒí—˜ê°€ ğŸ‚', 'desc': 'ì—ë„ˆì§€ê°€ ë„˜ì¹˜ê³  í™œë™ì ì´ì—ìš”! ì¹œêµ¬ë“¤ê³¼ ì–´ìš¸ë¦¬ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ê³ , ìƒˆë¡œìš´ ì¼ì— ë„ì „í•˜ëŠ” ê²ƒì„ ì¦ê²¨ìš”.' },
    'ESFP': { 'nickname': 'ììœ ë¡œìš´ ìŠˆí¼ìŠ¤íƒ€ ğŸŒŸ', 'desc': 'ì–¸ì œë‚˜ ë°ê³  ì¸ê¸°ê°€ ë§ì•„ìš”! ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ë‚´ëŠ” ê²ƒì„ ê°€ì¥ ì¢‹ì•„í•´ìš”.' },
    'ENFP': { 'nickname': 'ë°˜ì§ì´ëŠ” í™œë™ê°€ âœ¨', 'desc': 'ìƒìƒë ¥ì´ í’ë¶€í•˜ê³  ì—´ì •ì´ ë„˜ì³ìš”! ìƒˆë¡œìš´ ì¹œêµ¬ ì‚¬ê·€ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ê³ , ì¬ë°ŒëŠ” ì¼ì„ ì°¾ì•„ë‹¤ë…€ìš”.' },
    'ENTP': { 'nickname': 'ëœ¨ê±°ìš´ í† ë¡ ê°€ ğŸ”¥', 'desc': 'ë§í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ê³ , ë˜‘ë˜‘í•œ ì¥ë‚œê¾¸ëŸ¬ê¸°ì˜ˆìš”. ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¡œ í† ë¡ í•˜ëŠ” ê²ƒì„ ì¦ê²¨ìš”.' },
    'ESTJ': { 'nickname': 'ë¯¿ìŒì§í•œ ë°˜ì¥ ğŸ§‘â€âš–ï¸', 'desc': 'ì±…ì„ê°ì´ ê°•í•˜ê³  ê³„íšì„ ì˜ ì„¸ì›Œìš”. ì¹œêµ¬ë“¤ì„ ì´ëŒê³  ê·œì¹™ì„ ì˜ ì§€í‚¤ëŠ” í›Œë¥­í•œ ë¦¬ë”ì˜ˆìš”.' },
    'ESFJ': { 'nickname': 'ì¹œì ˆí•œ ë¶„ìœ„ê¸° ë©”ì´ì»¤ ğŸ’–', 'desc': 'ì¹œì ˆí•˜ê³  ì¹œêµ¬ë“¤ì„ ì˜ ì±™ê²¨ìš”. ë‹¤ë¥¸ ì‚¬ëŒì„ ë•ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ê³ , ì£¼ë³€ ë¶„ìœ„ê¸°ë¥¼ ë°ê²Œ ë§Œë“¤ì–´ìš”.' },
    'ENFJ': { 'nickname': 'ì •ì˜ë¡œìš´ ì£¼ì¸ê³µ ğŸ¦¸', 'desc': 'ì¹œêµ¬ë“¤ì—ê²Œ ê´€ì‹¬ì´ ë§ê³ , ë‹¤ë¥¸ ì‚¬ëŒì„ ë•ê¸° ìœ„í•´ ì•ì¥ì„œëŠ” ì •ì˜ë¡­ê³  ë”°ëœ»í•œ ë¦¬ë”ì˜ˆìš”.' },
    'ENTJ': { 'nickname': 'ëŒ€ë‹´í•œ ì§€íœ˜ê´€ ğŸ–ï¸', 'desc': 'ìì‹ ê°ì´ ë„˜ì¹˜ê³ , ì¹œêµ¬ë“¤ì„ ì´ë„ëŠ” ê²ƒì„ ì˜í•´ìš”. í° ê¿ˆì„ ê°–ê³  ë„ì „í•˜ëŠ” ê²ƒì„ ë‘ë ¤ì›Œí•˜ì§€ ì•Šì•„ìš”.' }
}

# 20ê°œ í€´ì¦ˆ ì§ˆë¬¸ (E/I, S/N, T/F, J/P ê° 5ê°œ)
questions = [
    # E (ì™¸í–¥) vs I (ë‚´í–¥)
    { 'question': 'ì£¼ë§ì— ë­ í•˜ê³  ì‹¶ì–´?', 'answers': [{ 'text': 'ì¹œêµ¬ë“¤ê³¼ ë°–ì—ì„œ ì‹ ë‚˜ê²Œ ë†€ê¸°', 'type': 'E' }, { 'text': 'ì§‘ì—ì„œ ì¡°ìš©íˆ ì±… ì½ê±°ë‚˜ ê·¸ë¦¼ ê·¸ë¦¬ê¸°', 'type': 'I' }] },
    { 'question': 'ìˆ˜ì—…ì‹œê°„ì— ë‚˜ëŠ”?', 'answers': [{ 'text': 'ì†ë“¤ê³  í° ì†Œë¦¬ë¡œ ë°œí‘œí•˜ëŠ” í¸', 'type': 'E' }, { 'text': 'ì¡°ìš©íˆ ë“£ê³  ì†ìœ¼ë¡œ ìƒê°í•˜ëŠ” í¸', 'type': 'I' }] },
    { 'question': 'ìƒˆë¡œìš´ ì¹œêµ¬ë¥¼ ë§Œë‚¬ì„ ë•Œ', 'answers': [{ 'text': 'ë‚´ê°€ ë¨¼ì € ë‹¤ê°€ê°€ì„œ ë§ì„ ê±´ë‹¤', 'type': 'E' }, { 'text': 'ì¹œêµ¬ê°€ ë¨¼ì € ë§ì„ ê±¸ì–´ì£¼ê¸¸ ê¸°ë‹¤ë¦°ë‹¤', 'type': 'I' }] },
    { 'question': 'ìƒì¼ íŒŒí‹°ë¥¼ í•œë‹¤ë©´?', 'answers': [{ 'text': 'ì¹œêµ¬ë“¤ì„ ë§ì´ ë¶ˆëŸ¬ì„œ ì‹œëŒë²…ì í•˜ê²Œ!', 'type': 'E' }, { 'text': 'ì¹œí•œ ì¹œêµ¬ ëª‡ ëª…ê³¼ ì¡°ìš©í•˜ê²Œ!', 'type': 'I' }] },
    { 'question': 'í˜ë“¤ ë•Œ ê¸°ë¶„ì´ í’€ë¦¬ëŠ” ë²•ì€?', 'answers': [{ 'text': 'ì¹œêµ¬ë“¤ê³¼ ìˆ˜ë‹¤ ë–¨ê¸°', 'type': 'E' }, { 'text': 'í˜¼ìë§Œì˜ ì‹œê°„ ê°–ê¸°', 'type': 'I' }] },
    # S (ê°ê°) vs N (ì§ê´€)
    { 'question': 'ì´ì•¼ê¸°ë¥¼ ë“¤ì„ ë•Œ ë” ì¬ë¯¸ìˆëŠ” ê²ƒì€?', 'answers': [{ 'text': 'ì§„ì§œ ìˆì—ˆë˜ ì¼, ìì„¸í•œ ì´ì•¼ê¸°', 'type': 'S' }, { 'text': 'ì•ìœ¼ë¡œ ì¼ì–´ë‚  ì¼, ìƒìƒ ì† ì´ì•¼ê¸°', 'type': 'N' }] },
    { 'question': 'ìƒˆë¡œìš´ ì¥ë‚œê°ì´ ìƒê¸°ë©´?', 'answers': [{ 'text': 'ì„¤ëª…ì„œë¥¼ ê¼¼ê¼¼íˆ ë³´ê³  ë”°ë¼ ë§Œë“ ë‹¤', 'type': 'S' }, { 'text': 'ì„¤ëª…ì„œ ì—†ì´ ë‚´ ë§˜ëŒ€ë¡œ ìƒˆë¡­ê²Œ ë§Œë“ ë‹¤', 'type': 'N' }] },
    { 'question': 'ë™í™”ì±…ì„ ì½ì„ ë•Œ ë‚˜ëŠ”?', 'answers': [{ 'text': 'ê·¸ë¦¼ì„ ìì„¸íˆ ì‚´í´ë³¸ë‹¤', 'type': 'S' }, { 'text': 'ë‹¤ìŒì— ì–´ë–»ê²Œ ë ì§€ ìƒìƒí•´ë³¸ë‹¤', 'type': 'N' }] },
    { 'question': 'ê¸¸ì„ ê±¸ì„ ë•Œ ë‚˜ëŠ”?', 'answers': [{ 'text': 'ê°„íŒì´ë‚˜ ì˜ˆìœ ê½ƒì„ êµ¬ê²½í•œë‹¤', 'type': 'S' }, { 'text': 'ë‹¤ë¥¸ ìƒê°ì´ë‚˜ ê³µìƒì— ë¹ ì§„ë‹¤', 'type': 'N' }] },
    { 'question': 'ë” ì¢‹ì•„í•˜ëŠ” ì¹­ì°¬ì€?', 'answers': [{ 'text': '"ê·¸ë¦¼ì„ ê¼¼ê¼¼í•˜ê²Œ ì˜ ê·¸ë ¸ë„¤!"', 'type': 'S' }, { 'text': '"ê·¸ë¦¼ ì•„ì´ë””ì–´ê°€ ì •ë§ ìƒˆë¡­ë‹¤!"', 'type': 'N' }] },
    # T (ì‚¬ê³ ) vs F (ê°ì •)
    { 'question': 'ì¹œêµ¬ê°€ ë„˜ì–´ì¡Œì„ ë•Œ ë‚˜ì˜ ì²«ë§ˆë””ëŠ”?', 'answers': [{ 'text': '"ì–´ë”” ë‹¤ì³¤ì–´? í”¼ ë‚˜?" (ìƒí™© íŒŒì•…)', 'type': 'T' }, { 'text': '"ì–´ë–¡í•´! ë§ì´ ì•„í”„ê² ë‹¤!" (ê³µê°)', 'type': 'F' }] },
    { 'question': 'ìˆ™ì œë¥¼ í•  ë•Œ ë” ì¤‘ìš”í•œ ê²ƒì€?', 'answers': [{ 'text': 'í‹€ë¦° ê²ƒ ì—†ì´ ì •í™•í•˜ê²Œ í•˜ëŠ” ê²ƒ', 'type': 'T' }, { 'text': 'ì„ ìƒë‹˜ ë§ˆìŒì— ë“¤ê²Œ ì˜ˆì˜ê²Œ í•˜ëŠ” ê²ƒ', 'type': 'F' }] },
    { 'question': 'ì¹œêµ¬ì™€ ë‹¤í‰œì„ ë•Œ', 'answers': [{ 'text': 'ëˆ„ê°€ ì˜ëª»í–ˆëŠ”ì§€ ë”°ì ¸ë³¸ë‹¤', 'type': 'T' }, { 'text': 'ì¹œêµ¬ê°€ ìƒì²˜ë°›ì•˜ì„ê¹Œ ë´ ê±±ì •ëœë‹¤', 'type': 'F' }] },
    { 'question': 'ë” ê¸°ë¶„ ì¢‹ì€ ë§ì€?', 'answers': [{ 'text': '"ë„ˆ ì •ë§ ë˜‘ë˜‘í•˜ë‹¤!"', 'type': 'T' }, { 'text': '"ë„ˆ ì •ë§ ì°©í•˜ë‹¤!"', 'type': 'F' }] },
    { 'question': 'ê²Œì„ì„ í•  ë•Œ ë‚˜ëŠ”?', 'answers': [{ 'text': 'ì´ê¸°ëŠ” ê²Œ ì œì¼ ì¤‘ìš”í•˜ë‹¤', 'type': 'T' }, { 'text': 'ë‹¤ ê°™ì´ ì¬ë¯¸ìˆëŠ” ê²Œ ë” ì¤‘ìš”í•˜ë‹¤', 'type': 'F' }] },
    # J (íŒë‹¨) vs P (ì¸ì‹)
    { 'question': 'ë°©í•™ ìˆ™ì œëŠ”?', 'answers': [{ 'text': 'ê³„íší‘œë¥¼ ì§œì„œ ë§¤ì¼ ì¡°ê¸ˆì”© ë¯¸ë¦¬ í•œë‹¤', 'type': 'J' }, { 'text': 'ë§ˆì§€ë§‰ ë‚ ì— ëª°ì•„ì„œ í•œë‹¤', 'type': 'P' }] },
    { 'question': 'ë‚´ ë°©ì€?', 'answers': [{ 'text': 'ë¬¼ê±´ì´ ì œìë¦¬ì— ì •ë¦¬ë˜ì–´ ìˆë‹¤', 'type': 'J' }, { 'text': 'ììœ ë¡­ê²Œ ë†“ì—¬ ìˆì§€ë§Œ ì–´ë”” ìˆëŠ”ì§€ ë‹¤ ì•ˆë‹¤', 'type': 'P' }] },
    { 'question': 'ì—¬í–‰ì„ ê°„ë‹¤ë©´?', 'answers': [{ 'text': 'ê°ˆ ê³³ì„ ë¯¸ë¦¬ ë‹¤ ì •í•´ë†“ê³  ê°„ë‹¤', 'type': 'J' }, { 'text': 'ê·¸ë•Œê·¸ë•Œ ë°œê¸¸ ë‹¿ëŠ” ëŒ€ë¡œ ë‹¤ë‹Œë‹¤', 'type': 'P' }] },
    { 'question': 'ì¹œêµ¬ì™€ ì•½ì†ì„ ì¡ì„ ë•Œ', 'answers': [{ 'text': 'ì‹œê°„ê³¼ ì¥ì†Œë¥¼ ì •í™•í•˜ê²Œ ì •í•˜ëŠ” ê²Œ í¸í•˜ë‹¤', 'type': 'J' }, { 'text': '"ê·¸ë•Œ ë§Œë‚˜!" ì²˜ëŸ¼ í¸í•˜ê²Œ ì •í•˜ëŠ” ê²Œ ì¢‹ë‹¤', 'type': 'P' }] },
    { 'question': 'ë” í¸í•œ ê²ƒì€?', 'answers': [{ 'text': 'í•  ì¼ì„ ë¯¸ë¦¬ ëë‚´ê³  ì‰¬ëŠ” ê²ƒ', 'type': 'J' }, { 'text': 'ë†€ë‹¤ê°€ ë§ˆì§€ë§‰ì— í•  ì¼ì„ í•˜ëŠ” ê²ƒ', 'type': 'P' }] }
]

# 16ê°€ì§€ ìœ í˜•ë³„ ì¶”ì²œ ì§ì—… 5ê°€ì§€
jobRecommendations = {
    'ISTJ': ['ì‚¬ì„œ', 'íšŒê³„ì‚¬', 'íŒì‚¬', 'ì•½ì‚¬', 'ê±´ì¶•ê°€'],
    'ISFJ': ['ì˜ì‚¬', 'ê°„í˜¸ì‚¬', 'ì„ ìƒë‹˜', 'ì‚¬íšŒë³µì§€ì‚¬', 'ìˆ˜ì˜ì‚¬'],
    'INFJ': ['ìƒë‹´ì‚¬', 'ì‘ê°€', 'ë””ìì´ë„ˆ', 'ì‹¬ë¦¬í•™ì', 'í™˜ê²½ìš´ë™ê°€'],
    'INTJ': ['ê³¼í•™ì', 'í”„ë¡œê·¸ë˜ë¨¸', 'ë³€í˜¸ì‚¬', 'ì—”ì§€ë‹ˆì–´', 'ê²½ì œí•™ì'],
    'ISTP': ['ì†Œë°©ê´€', 'ìš”ë¦¬ì‚¬', 'ìš´ë™ì„ ìˆ˜', 'ì •ë¹„ì‚¬', 'íŒŒì¼ëŸ¿'],
    'ISFP': ['í™”ê°€', 'ê°€ìˆ˜', 'íŒ¨ì…˜ ë””ìì´ë„ˆ', 'ê½ƒì§‘ ì£¼ì¸', 'ë³´ì„ ë””ìì´ë„ˆ'],
    'INFP': ['ì‘ê°€', 'ë§Œí™”ê°€', 'ë°°ìš°', 'ì‚¬ì„œ', 'ìœ ì¹˜ì› ì„ ìƒë‹˜'],
    'INTP': ['í”„ë¡œê·¸ë˜ë¨¸', 'ê³¼í•™ì', 'ë°œëª…ê°€', 'ëŒ€í•™êµìˆ˜', 'ë¹„í‰ê°€'],
    'ESTP': ['ìš´ë™ì„ ìˆ˜', 'ê²½ì°°ê´€', 'ì‚¬ì—…ê°€', 'ìœ íŠœë²„', 'ì‘ê¸‰êµ¬ì¡°ì‚¬'],
    'ESFP': ['ë°°ìš°', 'ê°€ìˆ˜', 'MC(ì§„í–‰ì)', 'ìŠ¹ë¬´ì›', 'ì´ë²¤íŠ¸ ê¸°íšì'],
    'ENFP': ['ìœ íŠœë²„', 'ì‘ê°€', 'ê´‘ê³  ê¸°íšì', 'ë°°ìš°', 'ê¸°ì'],
    'ENTP': ['ë°œëª…ê°€', 'ë³€í˜¸ì‚¬', 'ì˜í™”ê°ë…', 'ê´‘ê³  ê¸°íšì', 'ì •ì¹˜ì¸'],
    'ESTJ': ['ì‚¬ì¥ë‹˜(CEO)', 'íŒì‚¬', 'êµì¥ ì„ ìƒë‹˜', 'ê°ë…', 'ê²½ì°°ê´€'],
    'ESFJ': ['ì„ ìƒë‹˜', 'ê°„í˜¸ì‚¬', 'ìŠ¹ë¬´ì›', 'ë¹„ì„œ', 'íŒŒí‹° í”Œë˜ë„ˆ'],
    'ENFJ': ['ì„ ìƒë‹˜', 'ìƒë‹´ì‚¬', 'ì•„ë‚˜ìš´ì„œ', 'ì‚¬íšŒë³µì§€ì‚¬', 'ì •ì¹˜ì¸'],
    'ENTJ': ['ì‚¬ì¥ë‹˜(CEO)', 'ë³€í˜¸ì‚¬', 'ì˜í™”ê°ë…', 'ì¥êµ°', 'ë°œëª…ê°€']
}


# -----------------------------------------------------------------
# 3. Streamlit ì•± ë¡œì§ (í™”ë©´ ê´€ë¦¬)
# -----------------------------------------------------------------

# 'st.session_state'ë¥¼ ì‚¬ìš©í•´ í˜„ì¬ ìƒíƒœ(í™”ë©´, ì ìˆ˜ ë“±)ë¥¼ ê¸°ì–µí•©ë‹ˆë‹¤.
if 'screen' not in st.session_state:
    st.session_state.screen = 'welcome'
    st.session_state.scores = { 'E': 0, 'I': 0, 'S': 0, 'N': 0, 'T': 0, 'F': 0, 'J': 0, 'P': 0 }
    st.session_state.current_question_index = 0
    st.session_state.mbti_type = ''
    st.session_state.selected_job = ''
    st.session_state.shuffled_questions = questions[:] # ì§ˆë¬¸ ëª©ë¡ ë³µì‚¬
    random.shuffle(st.session_state.shuffled_questions) # ì§ˆë¬¸ ì„ê¸°

# --- í™”ë©´ ì „í™˜ì„ ìœ„í•œ í•¨ìˆ˜ë“¤ ---

def start_quiz():
    """í€´ì¦ˆ ì‹œì‘ (ì§ˆë¬¸ ì„ê¸° ë° ì´ˆê¸°í™”)"""
    st.session_state.scores = { 'E': 0, 'I': 0, 'S': 0, 'N': 0, 'T': 0, 'F': 0, 'J': 0, 'P': 0 }
    st.session_state.current_question_index = 0
    st.session_state.shuffled_questions = questions[:]
    random.shuffle(st.session_state.shuffled_questions)
    st.session_state.screen = 'quiz'

def select_answer(answer_type):
    """ë‹µë³€ ì„ íƒ ì‹œ ì ìˆ˜ ì˜¬ë¦¬ê³  ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ"""
    st.session_state.scores[answer_type] += 1
    st.session_state.current_question_index += 1
    if st.session_state.current_question_index >= len(questions):
        calculate_result()
        st.session_state.screen = 'result'

def calculate_result():
    """MBTI ê²°ê³¼ ê³„ì‚°"""
    scores = st.session_state.scores
    mbti = ''
    mbti += 'E' if scores['E'] > scores['I'] else 'I'
    mbti += 'S' if scores['S'] > scores['N'] else 'N'
    mbti += 'T' if scores['T'] > scores['F'] else 'F'
    mbti += 'J' if scores['J'] > scores['P'] else 'P'
    st.session_state.mbti_type = mbti

def select_job(job):
    """ì§ì—… ì„ íƒ ì‹œ AI ì„¤ëª… í™”ë©´ìœ¼ë¡œ"""
    st.session_state.selected_job = job
    st.session_state.screen = 'job_ai'

def restart_quiz():
    """ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°"""
    st.session_state.screen = 'welcome'
    # ì„¸ì…˜ ìƒíƒœì˜ ë‹¤ë¥¸ ê°’ë“¤ì€ start_quizì—ì„œ ë‹¤ì‹œ ì´ˆê¸°í™”ë¨


# --- ê° í™”ë©´ ê·¸ë¦¬ê¸° ---

# 1. ì‹œì‘ í™”ë©´
if st.session_state.screen == 'welcome':
    st.title("ë‚˜ì˜ MBTI ì§„ë¡œ íƒí—˜! ğŸ¤–")
    st.image("https://placehold.co/600x300/A5B4FC/312E81?text=My+MBTI+Quiz!", 
             use_column_width=True, 
             caption="ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ë¯¸ë˜ ì§ì—…ì€?")
    st.markdown("""
    <p style="font-size: 1.2rem; text-align: center;">
        ë‚˜ëŠ” ì–´ë–¤ ì‚¬ëŒì¼ê¹Œ?<br>
        20ê°œì˜ ê°„ë‹¨í•œ í€´ì¦ˆë¡œ<br>
        ë‚˜ì˜ MBTIì™€ ì–´ìš¸ë¦¬ëŠ” ì§ì—…ì„ ì°¾ì•„ë³´ì•„ìš”!
    </p>
    """, unsafe_allow_html=True)
    
    st.button("ì‹œì‘!", on_click=start_quiz, use_container_width=True, type="primary")

# 2. í€´ì¦ˆ í™”ë©´
elif st.session_state.screen == 'quiz':
    idx = st.session_state.current_question_index
    q = st.session_state.shuffled_questions[idx]
    
    # ì§„í–‰ë„
    st.progress((idx + 1) / len(questions))
    st.markdown(f"### ì§ˆë¬¸ {idx + 1}/{len(questions)}")
    
    # ì§ˆë¬¸
    st.title(q['question'])
    
    # ë‹µë³€ ë²„íŠ¼ 2ê°œ
    col1, col2 = st.columns(2)
    with col1:
        st.button(q['answers'][0]['text'], 
                  on_click=select_answer, 
                  args=(q['answers'][0]['type'],), 
                  use_container_width=True,
                  key='answer1')
    with col2:
        st.button(q['answers'][1]['text'], 
                  on_click=select_answer, 
                  args=(q['answers'][1]['type'],), 
                  use_container_width=True,
                  key='answer2')

# 3. ê²°ê³¼ í™”ë©´
elif st.session_state.screen == 'result':
    mbti = st.session_state.mbti_type
    result_data = descriptions[mbti]
    
    st.markdown("ë‚˜ì˜ MBTI ìœ í˜•ì€...")
    st.title(f"{mbti} ({result_data['nickname']})")
    st.info(result_data['desc'])
    
    st.markdown("---")
    st.subheader("ì´ëŸ° ì§ì—…ì€ ì–´ë•Œìš”?")
    
    # ì¶”ì²œ ì§ì—… ë²„íŠ¼ (5ê°œë¥¼ 2x3 ê·¸ë¦¬ë“œë¡œ ë°°ì¹˜)
    jobs = jobRecommendations[mbti]
    cols = st.columns(2)
    for i, job in enumerate(jobs):
        col = cols[i % 2]
        with col:
            col.button(job, on_click=select_job, args=(job,), use_container_width=True)

    st.button("ë‹¤ì‹œí•˜ê¸°", on_click=restart_quiz, use_container_width=True)

# 4. ì§ì—… AI ì„¤ëª… í™”ë©´ (ì´ë¯¸ì§€ -> í…ìŠ¤íŠ¸ ìƒì„±ìœ¼ë¡œ ë³€ê²½)
elif st.session_state.screen == 'job_ai':
    job = st.session_state.selected_job
    mbti = st.session_state.mbti_type
    
    st.title(f"AIê°€ ì•Œë ¤ì£¼ëŠ” '{job}' ğŸ¤–")
    
    # AIì—ê²Œ ë¬¼ì–´ë³¼ í”„ë¡¬í”„íŠ¸
    prompt = f"ì´ˆë“±í•™ìƒë„ ì´í•´í•˜ê¸° ì‰½ê²Œ, MBTIê°€ {mbti}ì¸ ì‚¬ëŒì—ê²Œ '{job}'ì´ë¼ëŠ” ì§ì—…ì´ ì™œ ì˜ ì–´ìš¸ë¦¬ëŠ”ì§€, ê·¸ë¦¬ê³  ì´ ì§ì—…ì€ êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ì¬ë¯¸ìˆëŠ” ì¼ì„ í•˜ëŠ”ì§€ 3~4ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•´ì¤˜."
    
    st.markdown("### ğŸ” ì œë¯¸ë‚˜ì´ AIì—ê²Œ ë¬¼ì–´ë³´ëŠ” ì¤‘...")
    
    try:
        # ì œë¯¸ë‚˜ì´ ëª¨ë¸ ìƒì„± ë° ì‘ë‹µ
        model = genai.GenerativeModel('gemini-pro')
        
        # st.spinner: ë¡œë”© ì¤‘ì„ì„ í‘œì‹œ
        with st.spinner(f"'{job}'ì— ëŒ€í•´ AIê°€ ì—´ì‹¬íˆ ìƒê° ì¤‘... ğŸ§ "):
            response = model.generate_content(prompt)
            st.success("ë‹µë³€ ë„ì°©! ğŸ’Œ")
            st.markdown(response.text)
            
    except Exception as e:
        st.error(f"AIì—ê²Œ ë¬¼ì–´ë³´ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ìƒê²¼ì–´ìš”: {e}")

    st.button("â—€ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°", on_click=lambda: st.session_state.update(screen='result'), use_container_width=True)
    st.button("ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°", on_click=restart_quiz, use_container_width=True)
